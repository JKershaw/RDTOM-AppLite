<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html manifest="cache.manifest">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>RDTOM App Lite</title>
<link rel="stylesheet" href="style.css" type="text/css" >

<meta name="viewport" content="width=device-width" >	

<script src="jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="jquery-ui-1.10.2.custom.js" type="text/javascript"></script>
<script src="defaultquestions.js" type="text/javascript"></script>


</head>
<body>

<h1>Roller Derby Test O'Matic (Lite)</h1>
<h2>Turn left and learn the rules.</h2>
	
<div id="page_start">

	<p style="text-align:center"><a id="startbutton" class="button mobilebutton" onclick="initiatequestions()">Click to start</a></p>
	<p style="text-align:center"><a id="aboutbutton" class="button mobilebutton" onclick="$('#div_about').slideToggle();$('#starticon').fadeToggle();">About</a></p>
	
	<div style="display:none;" id="div_about">
		<p>This app is a based on the Roller Derby Test O'Matic website (available at <a href="http://rollerderbytestomatic.com">rollerderbytestomatic.com</a>), used by thousands of skaters and officials worldwide to help learn the WFTDA rules of flat track derby. The website has a lot more to offer, including user accounts, statistics tracking and a mock-test generator; This app is simply a <i>lite</i> version. A fancy-pants feature rich app is on the way.</p>
		
		<p>There a full set of questions already in this app ready to be use. If you have an internet connection the app will attempt to download any updates or new questions whenever the app is loaded.</p>

		<p>If you have any bug reports, feedback, questions or feature requests, please head over to the RDTOM forum (<a href="http://rollerderbytestomatic.com/forum">rollerderbytestomatic.com/forum</a>) or send an email to contact@rollerderbytestomatic.com.</p>

		<p>This App and the RDTOM website are both made by Sausage Roller (aka John Kershaw) a skater with Manchester Roller Derby in the UK and a full-time freelance developer. He likes coffee.</p>
	</div>
	
	<p style="text-align:center"><img id="starticon" style="cursor:pointer; max-width:60%;" onclick="initiatequestions()" src="RDTOM_touch_icon.png"/></p>
	
	<p style="text-align:center" id="initiatingtext"></p>
	<p style="text-align:center; display:none;" id="loadingtext"></p>
</div>

<div id="page_question" style="display:none;">

	<p id="question"></p>
	
	<ol type="A" id="answers">
	</ol>

	<p>
		<a class="button mobilebutton" onclick="loadquestion()">New question</a>
	</p>

</div>


<script type="text/javascript">

document.addEventListener("deviceready", function(){
	// hide the splash screen asap
	navigator.splashscreen.hide();
});

var data_questions;

var have_answered = false;

var loadingAnimationVar;

function initiatequestions()
{
	$("#startbutton").hide();
	$("#aboutbutton").hide();
	$("#starticon").hide();
	$('#div_about').hide();
	$("#initiatingtext").show();
	
	$("#initiatingtext").append("Browser status: ");
	
	// can we load from the server?
	if (checkNetworkStatus()) 
	{
		$("#initiatingtext").append("Connected!<br />");
		$("#initiatingtext").append("Looking for the server<br />");
		
		$("#loadingtext").fadeIn();
		loadingAnimationVar = setInterval(function(){loadingAnimation(true)},500);
		
		// load questions
		
		// first see if the server is there and if it's worth continuing. This JS file is not valid, so will generate a parser error if loaded
		$.ajax({  
		    url: "http://rollerderbytestomatic.com/ping.js",  
		    dataType: "jsonp", 
		    timeout: 2000,
		    error: function(xhr, textStatus, errorThrown){
		    	if (textStatus == "parsererror")
		    	{
		    		$("#initiatingtext").append("Found the server, downloading questions<br />");
					$.ajax({  
					    url: "http://rollerderbytestomatic.com/api/0.1/jsonp/questions/?callback=callback&developer=rdtom&application=rdtomlite0_3",  
					    dataType: "jsonp", 
					    timeout: 10000,
					    success: function(data) { 
					    	$("#initiatingtext").append("Questions Loaded<br />");
					    	save_data_question(data);
					    	$("#initiatingtext").append("Local cache updated<br />");
					    	$("#initiatingtext").append("Reticulating Splines<br />");

							loadingAnimation(false);
							loadfromlocal();
					    } ,
					    error: function(xhr, textStatus, errorThrown){
					    	$("#initiatingtext").append("No questions available, that's ok<br />");
					    	console.debug(textStatus);
							loadingAnimation(false);
							loadfromlocal();
					    }
					}); 
		    	}
		    	else
		    	{
			    	$("#initiatingtext").append("Lost interest<br />");
			    	console.debug(textStatus);
					loadingAnimation(false);
					loadfromlocal();
			    }
		    }
		}); 
	}
	else
	{
		$("#initiatingtext").append("Offline<br />");
		loadfromlocal();
	}
}

// the loading animation when downloading updates
function loadingAnimation(start)
{
	if (start)
	{
		$("#loadingtext").append(".");
	}
	else
	{
		clearInterval(loadingAnimationVar);
		$("#loadingtext").hide();
	}
}

// load a new question
function loadquestion()
{
	have_answered = false;
	
	// get rid of the old answers
	$("#answers").html("");

	$("#question").html("Loading ... ");
	
	var is_valid = true;
	var correct_answer = 0;
	
	question_data = data_questions.resource.questions.question[Math.floor(Math.random() *  data_questions.resource.questions.question.length)];
	
	// check for any "null" values caused by bad data
	$.each(question_data.answers.answer, function(key, answer) 
	{
		if (answer.text == null)
		{
			console.debug("Null value detected: Question " + question_data.id + ", Answer " + answer.id);
			is_valid = false;
		}
		if (answer.correct == "true")
		{
			correct_answer = answer.id;
		}
	});
	
	// Basic validation to weed out bad data
	
	// If there's no correct answer, this is an invalid question
	if (correct_answer == 0)
	{
		is_valid = false;
	}
	
	// if it's not valid, try again. Chances of it being not valid twice are tiny. Should fix this
	if (!is_valid)
	{
		question_data = data_questions.resource.questions.question[Math.floor(Math.random() *  data_questions.resource.questions.question.length)];
	}
	
	// show the new question
	showquestion(question_data);

}

// show a question
var answered = false;
var correct_answer = 0;
var section_string;

function showquestion(data)
{
	answered = false;
	// show the new question text
	
	
	$("#question").html(unescape((data.text).replace(/\\(.)/mg, "$1")));

	$("#answers").html();
	
	
	// get the section string
	$(data.sections).each(function( index, section ) {
		section_string = section.section;	
		return false;
	});
	
	// load each new answer
	$.each(data.answers.answer, function(key, answer) 
	{
		if (answer.correct == "true")
		{
			correct_answer = answer.id;
			
			$("#answers").append("<li><a class=\"mobilebutton\" onclick=\"select_answer(" + answer.id + ");\">" + (answer.text).replace(/\\(.)/mg, "$1") + "</a> <span style=\"display:none;\" class=\"correct_answer_win\"><strong>You Win!</strong> (See rule " + section_string + ")</span><span style=\"display:none;\" class=\"correct_answer\"><strong> The correct answer.</strong>  (See rule " + section_string + ")</span></li>");
		}
		else
		{
			$("#answers").append("<li><a class=\"mobilebutton\" onclick=\"select_answer(" + answer.id + ");\">" + (answer.text).replace(/\\(.)/mg, "$1") + "</a> <span style=\"display:none;\" class=\"wrong_answer\" id=\"wrong_answer" + answer.id + "\"><strong>Wrong!</strong></span></li>");
		}
			
	 });
}

// select an answer
function select_answer(selected)
{
	if (!answered)
	{
		// make sure we only answer once
		answered = true;

		// show what was right and what was wrong
		if (selected == correct_answer)
		{
			// correct!
			$(".correct_answer_win").show();
			$('body').effect("highlight", {color:"#00FF00"}, 1000);
		}
		else
		{
			// wrong!
			$(".correct_answer").show();
			$("#wrong_answer" + selected).show();
			$('body').effect("highlight", {color:"#FF0000"}, 1000);
		}		
	}
}


function save_data_question(data)
{
	localStorage.setItem('data_questions',JSON.stringify(data));
}


// load the questions from local, return false on failure
function load_data_question()
{
	try
	{
		if (localStorage.getItem('data_questions'))
		{
			return JSON.parse(localStorage.getItem('data_questions'));
		}
	}
	catch(err)
	{
		return false
	}
}

function loadfromlocal()
{
	// can we use localstorage?
	$("#initiatingtext").append("Local storage: ");
	
	data_questions = load_data_question();

	if (data_questions)
	{
		// the data has been loaded
		$("#initiatingtext").append("Loaded<br />");
	}
	else
	{
		// couldn't find the data
		$("#initiatingtext").append("Missing<br />");
		
		// so use the default file
		$("#initiatingtext").append("Using the default file<br />");
    	data_questions = default_questions;
	}
	
	// questions is now an array of JS objects representing questions
	$("#initiatingtext").append("Questions loaded: " + data_questions.resource.questions.question.length + "<br />");
	
	// save the initiating text to the console
	console.debug($("#initiatingtext").html());
	
	// once all loaded
	
	// all loaded, so move on
	$("#page_start").fadeOut('fast', function() {
		$("#page_question").fadeIn();
	});
}

function checkNetworkStatus() 
{
    if (navigator.onLine) 
    {
    	return true;
    }
    else 
    {
    	 return false;
    }
}
</script>

</body>
</html>