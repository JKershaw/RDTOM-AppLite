<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html manifest="cache.manifest">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>RDTOM App Lite</title>
<link rel="stylesheet" href="style.css" type="text/css" >

<meta name="viewport" content="width=device-width" >

<script src="jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="jquery-ui-1.10.2.custom.js" type="text/javascript"></script>
<script src="defaultquestions.js" type="text/javascript"></script>


</head>
<body>

<h1>Roller Derby Test O'Matic (Lite)</h1>
<h2>Turn left and learn the rules.</h2>
	
<div id="page_start">

	<p style="text-align:center"><img id="starticon"  src="RDTOM_touch_icon.png"/></p>
	<p style="text-align:center"><a id="startbutton" class="button mobilebutton" onclick="initiatequestions()">Start</a></p>
	<p style="text-align:center" id="initiatingtext"></p>
</div>

<div id="page_question" style="display:none;">

	<p id="question"></p>
	
	<ol type="A" id="answers">
	</ol>

<p>
	<a class="button mobilebutton" onclick="loadquestion()">New question</a>
</p>

	
	
</div>


<script type="text/javascript">

var data_questions;

var have_answered = false;

function initiatequestions()
{
	$("#startbutton").hide();
	$("#starticon").hide();
	$("#initiatingtext").show();
	
	$("#initiatingtext").append("Online status: ");
	
	// can we load from the server?
	if (navigator.onLine) 
	{
		$("#initiatingtext").append("Connected!<br />");
		$("#initiatingtext").append("Downloading updates<br />");
		
		// load questions
		// TODO Callback in ajax call
		$.ajax({  
		    url: "http://rollerderbytestomatic.com/api/0.1/jsonp/questions/?callback=callback",  
		    dataType: "jsonp", 
		    timeout: 5000,
		    success: function(data) { 
		    	$("#initiatingtext").append("Updates Loaded<br />");
		    	localStorage.setItem('data_questions',JSON.stringify(data));
		    	$("#initiatingtext").append("Local cache updated<br />");
		    	$("#initiatingtext").append("Reticulating Splines<br />");
		    	
				loadfromlocal();
		    } ,
		    error: function(xhr, textStatus, errorThrown){
		    	$("#initiatingtext").append("No updates available<br />");
				loadfromlocal();
		    }
		});  
		// save to cache
		
	}
	else
	{
		$("#initiatingtext").append("Offline<br />");
		loadfromlocal();
	}

	
}

function loadfromlocal()
{
	
	// can we use localstorage?
	$("#initiatingtext").append("Local storage: ");
	
	data_questions = JSON.parse(localStorage.getItem('data_questions'));
	
	if (data_questions)
	{
		$("#initiatingtext").append("Loaded<br />");
	}
	else
	{
		// if none of the above, load the default data
		$("#initiatingtext").append("Missing<br />");
		$("#initiatingtext").append("Using the default file<br />");
    	localStorage.setItem('data_questions',JSON.stringify(default_questions));
    	$("#initiatingtext").append("Local cache has been updated<br />");
    	data_questions = default_questions;
    	
		
	}
	
	// questions is now an array of JS objects representing questions
	
	$("#initiatingtext").append("Questions loaded: " + data_questions.resource.questions.question.length + "<br />");
	
	$("#page_start").fadeOut('fast', function() {
		$("#page_question").fadeIn();
	});
}

// load a new question
function loadquestion()
{
	have_answered = false;
	
	// get rid of the old answers
	$("#answers").html("");

	question_data = data_questions.resource.questions.question[Math.floor(Math.random() *  data_questions.resource.questions.question.length)];
	
	$("#question").html("Loading ... ");
	
	// get the new question
	showquestion(question_data)

	
}


var answered = false;
var correct_answer = 0;

function showquestion(data)
{
	answered = false;
	// show the new question text
	
	$("#question").html(unescape((data.text).replace(/\\(.)/mg, "$1")));

	$("#answers").html();
	
	// load each new answer
	$.each(data.answers.answer, function(key, answer) 
	{
		if (answer.correct == "true")
		{
			correct_answer = answer.id;
			$("#answers").append("<li><a class=\"mobilebutton\" onclick=\"select_answer(" + answer.id + ");\">" + (answer.text).replace(/\\(.)/mg, "$1") + "</a> <span style=\"display:none;\" class=\"correct_answer_win\"><strong>You Win!</strong></span><span style=\"display:none;\" class=\"correct_answer\"><strong> The correct answer.</strong></span></li>");
		}
		else
		{
			$("#answers").append("<li><a class=\"mobilebutton\" onclick=\"select_answer(" + answer.id + ");\">" + (answer.text).replace(/\\(.)/mg, "$1") + "</a> <span style=\"display:none;\" class=\"wrong_answer\" id=\"wrong_answer" + answer.id + "\"><strong>Wrong!</strong></span></li>");
		}
			
	 });
}


function select_answer(selected)
{
	if (!answered)
	{
		// make sure we only answer once
		answered = true;

		// show what was right and what was wrong
		if (selected == correct_answer)
		{
			// correct!
			$(".correct_answer_win").show();
			$('body').effect("highlight", {color:"#00FF00"}, 1000);
		}
		else
		{
			// wrong!
			$(".correct_answer").show();
			$("#wrong_answer" + selected).show();
			$('body').effect("highlight", {color:"#FF0000"}, 1000);
		}

		//<?php if ($question->get_Notes()) {?>
		// show the notes
		//$(".question_notes").show();
		//<?php } ?>
		
	}
}

</script>

</body>
</html>